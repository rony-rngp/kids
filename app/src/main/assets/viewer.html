<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Remote Kids Monitor Control</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        input[type="text"] {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 10px;
            font-size: 16px;
        }
        button {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            font-size: 16px;
            cursor: pointer;
        }
        #status, #locationData {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            min-height: 50px;
            white-space: pre-wrap; /* Preserve whitespace and line breaks */
        }
        #videoFeed {
            width: 100%;
            max-width: 640px;
            height: auto;
            border: 1px solid #ccc;
            margin-top: 20px;
            display: none; /* Hidden by default */
        }
        .container {
            max-width: 400px;
            margin: auto;
            padding: 20px;
            border: 1px solid #eee;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Remote Kids Monitor Control</h1>

        <p>
            Enter the IP address of the monitored Android device (e.g., 192.168.1.100).
            The Android app's UI will show the IP address when the service starts.
        </p>
        <input type="text" id="ipAddress" placeholder="Enter Phone IP Address"> (Port: 8082 for WebSocket, 8081 for MJPEG)
        <button onclick="connectWebSocket()">Connect</button>
        <button onclick="disconnectWebSocket()">Disconnect</button>

        <h2>Status</h2>
        <div id="status">Not Connected</div>

        <h2>Live Video Feed</h2>
        <img id="videoFeed" src="" alt="Live Video Stream">

        <h2>Running Services</h2>
        <div id="serviceStatus">Camera: OFF, Audio: OFF</div>

        <h2>Controls</h2>
        <div id="controls" style="display: none;">
            <button onclick="sendCommand('startMonitoring')">Start Monitoring (Back Cam)</button>
            <button onclick="sendCommand('switchCamera', { facing: 'front' })">Switch to Front Camera</button>
            <button onclick="sendCommand('switchCamera', { facing: 'back' })">Switch to Back Camera</button>
            <button onclick="sendCommand('audioOn')">Start Audio Monitoring</button>
            <button onclick="sendCommand('audioOff')">Stop Audio Monitoring</button>
            <button onclick="sendCommand('stopMonitoring')">Stop Monitoring</button>
        </div>
    </div>

    <script>
        let ws;
        const statusDiv = document.getElementById('status');
        const ipAddressInput = document.getElementById('ipAddress');
        const controlsDiv = document.getElementById('controls');
        const videoFeedImg = document.getElementById('videoFeed');
        const serviceStatusDiv = document.getElementById('serviceStatus');

        let audioContext;
        let nextAudioTime = 0;
        let isCameraOn = false;
        let isAudioOn = false;

        function updateStatus(message, append = true) {
            const now = new Date();
            const formattedMessage = `<strong>[${now.toLocaleTimeString()}]</strong> ${message}`;
            if (append) {
                statusDiv.innerHTML = formattedMessage + '<br>' + statusDiv.innerHTML;
            } else {
                statusDiv.innerHTML = formattedMessage;
            }
        }

        function updateServiceStatus() {
            serviceStatusDiv.textContent = `Camera: ${isCameraOn ? 'ON' : 'OFF'}, Audio: ${isAudioOn ? 'ON' : 'OFF'}`;
        }

        function connectWebSocket() {
            const ip = ipAddressInput.value;
            if (!ip) {
                updateStatus('Error: Please enter the phone\'s IP address.');
                return;
            }
            const wsUrl = `ws://${ip}:8082`;

            if (ws && ws.readyState === WebSocket.OPEN) {
                updateStatus('Already connected.');
                return;
            }

            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
                nextAudioTime = audioContext.currentTime;
            } catch (e) {
                console.error("Web Audio API is not supported in this browser.", e);
                updateStatus('Web Audio API not supported.');
                return;
            }

            updateStatus('Attempting to connect to WebSocket...');
            ws = new WebSocket(wsUrl);
            ws.binaryType = 'arraybuffer';

            ws.onopen = () => {
                updateStatus('WebSocket Connected. Controls enabled.', false);
                controlsDiv.style.display = 'block';
                isCameraOn = false;
                isAudioOn = false;
                updateServiceStatus();
                // APK will send IP automatically on connection
            };

            ws.onmessage = (event) => {
                if (event.data instanceof ArrayBuffer) {
                    const rawData = new Int16Array(event.data);
                    const floatData = new Float32Array(rawData.length);
                    for (let i = 0; i < rawData.length; i++) {
                        floatData[i] = rawData[i] / 32768.0;
                    }
                    
                    const audioBuffer = audioContext.createBuffer(1, floatData.length, 16000);
                    audioBuffer.copyToChannel(floatData, 0);
                    
                    playBuffer(audioBuffer);
                } else {
                    try {
                        const message = JSON.parse(event.data);
                        if (message.type === 'status') {
                            updateStatus(`APK Status: ${message.message}`);
                            if (message.message.includes('Monitoring started')) {
                                isCameraOn = true;
                            } else if (message.message.includes('Monitoring stopped')) {
                                isCameraOn = false;
                                isAudioOn = false; // Audio also stops when monitoring stops
                            } else if (message.message.includes('Audio monitoring started')) {
                                isAudioOn = true;
                            } else if (message.message.includes('Audio monitoring stopped')) {
                                isAudioOn = false;
                            } else if (message.message.includes('Camera switched to')) {
                                // Camera switch doesn't change overall monitoring state, just the camera used
                            }
                            updateServiceStatus();
                        } else if (message.type === 'error') {
                            updateStatus(`APK Error: ${message.message}`);
                        } else if (message.type === 'ipAddress') {
                            ipAddressInput.value = message.ip; // Auto-fill if not already set by user
                            updateStatus(`APK IP: ${message.ip}`);
                        }
                        else {
                            updateStatus(`Received: ${event.data}`);
                        }
                    } catch (e) {
                        updateStatus(`Received (non-JSON text): ${event.data}`);
                    }
                }
            };

            ws.onclose = () => {
                updateStatus('WebSocket Disconnected. Controls disabled.', false);
                controlsDiv.style.display = 'none';
                videoFeedImg.style.display = 'none';
                videoFeedImg.src = '';
                if (audioContext && audioContext.state !== 'closed') {
                    audioContext.close();
                }
                isCameraOn = false;
                isAudioOn = false;
                updateServiceStatus();
            };

            ws.onerror = (error) => {
                updateStatus(`WebSocket Error: ${error.message || 'Unknown error'}`, false);
                console.error('WebSocket Error:', error);
            };
        }

        function playBuffer(buffer) {
            if (!audioContext || audioContext.state === 'closed') return;
            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            source.connect(audioContext.destination);
            
            const currentTime = audioContext.currentTime;
            if (currentTime < nextAudioTime) {
                source.start(nextAudioTime);
                nextAudioTime += buffer.duration;
            } else {
                source.start();
                nextAudioTime = currentTime + buffer.duration;
            }
        }

        function disconnectWebSocket() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.close();
            } else {
                updateStatus('Not connected.', false);
            }
        }

        function sendCommand(commandType, data = {}) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const command = {
                    type: commandType,
                    data: data
                };
                ws.send(JSON.stringify(command));
                updateStatus(`Sent command: ${commandType}`);

                if (commandType === 'startMonitoring') {
                    const ip = ipAddressInput.value;
                    if (ip) {
                        videoFeedImg.src = `http://${ip}:8081`;
                        videoFeedImg.style.display = 'block';
                    } else {
                        updateStatus('Cannot start video feed: IP address not set.');
                    }
                } else if (commandType === 'stopMonitoring') {
                    videoFeedImg.style.display = 'none';
                    videoFeedImg.src = '';
                } else if (commandType === 'audioOn') {
                    isAudioOn = true;
                } else if (commandType === 'audioOff') {
                    isAudioOn = false;
                }
                updateServiceStatus();

            } else {
                updateStatus('Not connected to WebSocket. Please connect first.');
            }
        }

        // Auto-fill IP from local storage or prompt
        window.onload = () => {
            const savedIp = localStorage.getItem('monitorIpAddress');
            if (savedIp) {
                ipAddressInput.value = savedIp;
            }

            ipAddressInput.addEventListener('change', () => {
                localStorage.setItem('monitorIpAddress', ipAddressInput.value);
            });
        };
    </script>
</body>
</html>